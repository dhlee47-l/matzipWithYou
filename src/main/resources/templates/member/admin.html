<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title>Admin Page</title>
  <!-- 부트스트랩 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style th:inline="css">
    .tab-content {
      display: none;
      padding: 20px;
    }
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
<!-- 관리자 확인 -->
<div sec:authorize="!hasRole('ROLE_ADMIN')" class="alert alert-danger">
  접근 권한이 없습니다.
</div>

<div sec:authorize="hasRole('ROLE_ADMIN')" class="container mt-4">
  <h1>관리자 페이지</h1>

  <!-- 탭 버튼들 -->
  <nav class="nav nav-tabs mt-4">
    <button class="nav-link active" data-tab="members">회원 목록</button>
    <button class="nav-link" data-tab="matzips">맛집 목록</button>
    <button class="nav-link" data-tab="tags">태그 목록</button>
    <button class="nav-link" data-tab="foodkinds">음식 종류 목록</button>
  </nav>

  <!-- 회원 목록 탭 -->
  <div id="members" class="tab-content active">
    <h2>회원 목록</h2>
    <table class="table table-striped">
      <thead>
      <tr>
        <th>ID</th>
        <th>아이디</th>
        <th>이메일</th>
        <th>닉네임</th>
        <th>포인트</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="member : ${members}">
        <td th:text="${member.id}"></td>
        <td th:text="${member.username}"></td>
        <td th:text="${member.email}"></td>
        <td th:text="${member.nickname}"></td>
        <td th:text="${member.point}"></td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- 맛집 목록 탭 -->
  <div id="matzips" class="tab-content">
    <h2>맛집 목록</h2>
    <table class="table table-striped">
      <thead>
      <tr>
        <th>ID</th>
        <th>이름</th>
        <th>주소</th>
        <th>음식 종류</th>
        <th>등록일</th>
      </tr>
      </thead>
      <tbody id="matzipsList"></tbody>
    </table>
  </div>

  <!-- 태그 목록 탭 -->
  <div id="tags" class="tab-content">
    <h2>태그 목록</h2>
    <table class="table table-striped">
      <thead>
      <tr>
        <th>ID</th>
        <th>태그명</th>
        <th>등록일</th>
      </tr>
      </thead>
      <tbody id="tagsList"></tbody>
    </table>
  </div>

  <!-- 음식 종류 목록 탭 -->
  <div id="foodkinds" class="tab-content">
    <h2>음식 종류 목록</h2>
    <table class="table table-striped">
      <thead>
      <tr>
        <th>ID</th>
        <th>종류명</th>
        <th>등록일</th>
      </tr>
      </thead>
      <tbody id="foodkindsList"></tbody>
    </table>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Custom JS -->
<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', function() {
    // 초기 데이터는 이미 서버에서 받아옴 (members)

    // 탭 버튼 이벤트 리스너
    document.querySelectorAll('.nav-link').forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();

        // 활성 탭 변경
        document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        this.classList.add('active');
        document.getElementById(this.dataset.tab).classList.add('active');

        // 데이터 로드
        if(this.dataset.tab !== 'members') { // members는 이미 서버에서 받아옴
          loadData(this.dataset.tab);
        }
      });
    });
  });

  function loadData(type) {
    fetch(`/admin/api/${type}`)
            .then(response => response.json())
            .then(data => {
              updateTable(type, data);
            })
            .catch(error => {
              console.error('Error:', error);
              alert('데이터를 불러오는데 실패했습니다.');
            });
  }

  function updateTable(type, data) {
    const tbody = document.getElementById(`${type}List`);
    switch(type) {
      case 'matzips':
        tbody.innerHTML = data.map(item => `
                        <tr>
                            <td>${item.id}</td>
                            <td>${item.name}</td>
                            <td>${item.address}</td>
                            <td>${item.kindId}</td>
                            <td>${formatDate(item.regdate)}</td>
                        </tr>
                    `).join('');
        break;
      case 'tags':
        tbody.innerHTML = data.map(item => `
                        <tr>
                            <td>${item.id}</td>
                            <td>${item.tagName}</td>
                            <td>${formatDate(item.regdate)}</td>
                        </tr>
                    `).join('');
        break;
      case 'foodkinds':
        tbody.innerHTML = data.map(item => `
                        <tr>
                            <td>${item.id}</td>
                            <td>${item.kindName}</td>
                            <td>${formatDate(item.regdate)}</td>
                        </tr>
                    `).join('');
        break;
    }
  }

  function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('ko-KR');
  }
</script>
</body>
</html>