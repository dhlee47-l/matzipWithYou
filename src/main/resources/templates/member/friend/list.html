<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>친구 목록</title>
</head>
<body>
<div class="friend-container">
    <div class="friend-header">
        <h1>친구 목록</h1>
    </div>

    <div class="friend-list" th:if="${not #lists.isEmpty(friends)}">
        <div th:each="friend : ${friends}" class="friend-item">
            <!-- OAuth 프로필 이미지 (URL로 저장된 경우) -->
            <img th:if="${friend.profileImg != null && friend.profileImg.startsWith('http')}"
                 th:src="${friend.profileImg}"
                 onerror="this.src='/IMG/defaultProfileImg.png'"
                 alt="OAuth Profile"
                 class="friend-profile">

            <!-- 일반 업로드된 프로필 이미지 -->
            <img th:if="${friend.profileImg != null && !friend.profileImg.startsWith('http')}"
                 th:src="@{'/upload/' + ${friend.profileImg}}"
                 onerror="this.src='/IMG/defaultProfileImg.png'"
                 alt="Profile"
                 class="friend-profile">

            <!-- 기본 프로필 이미지 -->
            <img th:if="${friend.profileImg == null}"
                 th:src="@{'/IMG/defaultProfileImg.png'}"
                 alt="Default Profile"
                 class="friend-profile">

            <div class="friend-info">
                <div class="friend-nickname" th:text="${friend.nickname}">닉네임</div>
                <div class="friend-username" th:text="${friend.username}">유저네임</div>
            </div>

            <div class="friend-actions">
                <button class="btn btn-delete"
                        th:data-sender-id="${friend.senderId}"
                        th:data-receiver-id="${friend.receiverId}">
                    삭제
                </button>
            </div>
        </div>
    </div>

    <div class="no-friends" th:if="${#lists.isEmpty(friends)}">
        <p>아직 등록된 친구가 없습니다.</p>
    </div>
</div>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        const deleteButtons = document.querySelectorAll('.btn-delete');

        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const senderId = parseInt(this.getAttribute('data-sender-id'));
                const receiverId = parseInt(this.getAttribute('data-receiver-id'));
                deleteFriend(senderId, receiverId);
            });
        });
    });

    function deleteFriend(senderId, receiverId) {
        if (confirm('정말 이 친구를 삭제하시겠습니까?')) {
            fetch(`/members/${receiverId}/friends`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    senderId: senderId,
                    receiverId: receiverId
                })
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Failed to delete friend');
                })
                .then(affectedRows => {
                    if (affectedRows > 0) {
                        // 성공적으로 삭제되면 UI에서 제거
                        const friendElement = this.closest('.friend-item');
                        friendElement.remove();

                        // 친구가 모두 삭제되었는지 확인
                        const remainingFriends = document.querySelectorAll('.friend-item');
                        if (remainingFriends.length === 0) {
                            const friendList = document.querySelector('.friend-list');
                            friendList.innerHTML = '<div class="no-friends"><p>아직 등록된 친구가 없습니다.</p></div>';
                        }
                    } else {
                        alert('친구 삭제에 실패했습니다.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('친구 삭제 중 오류가 발생했습니다.');
                });
        }
    }
</script>

</body>
</html>