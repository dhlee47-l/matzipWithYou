<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lec.spring.member.repository.FriendRepository">
    <sql id="SELECT_BASE">
        SELECT sender_id "sender_id"
            , receiver_id "receiver_id"
            , intimacy "intimacy"
            , is_accept "is_accept"
            , regdate "regdate"
        FROM friend
        WHERE 1 = 1
    </sql>

    <insert id="save" flushCache="true" parameterType="com.lec.spring.member.domain.Friend">

    </insert>


    <!-- 친구 요청 보내기 -->
    <insert id="sendFriendRequest" parameterType="com.lec.spring.member.domain.Friend">
        INSERT INTO friend (sender_id, receiver_id, is_accept, regdate)
        VALUES (#{senderId}, #{receiverId}, false, now())
    </insert>

    <!-- 내가 보낸 요청 중 대기 중인 목록 -->
    <select id="findPendingSentRequests" parameterType="com.lec.spring.member.domain.Friend" resultType="com.lec.spring.member.domain.Friend">
        SELECT * FROM friend
        WHERE sender_id = #{member.id}
          AND is_accept = false
    </select>

    <!-- 내가 받은 요청 중 대기 중인 목록 -->
    <select id="findPendingReceivedRequests" parameterType="com.lec.spring.member.domain.Friend" resultType="com.lec.spring.member.domain.Friend">
        SELECT * FROM friend
        WHERE receiver_id = #{member.id}
          AND is_accept = false
    </select>

    <!-- 내가 보낸 요청과 받은 요청 중 대기 중인 목록 -->
    <select id="findPendingRequests" parameterType="com.lec.spring.member.domain.Friend" resultType="com.lec.spring.member.domain.Friend">
        SELECT * FROM friend
        WHERE (sender_id = #{member.id} OR receiver_id = #{member.id})
          AND is_accept = false
    </select>

    <!-- 친구 요청 수락 -->
    <update id="acceptFriendRequest" parameterType="com.lec.spring.member.domain.Friend">
        UPDATE friend
        SET is_accept = true
        WHERE sender_id = #{senderId}
          AND receiver_id = #{receiverId}
    </update>

    <!-- 친구 요청 거절 -->
    <delete id="rejectFriendRequest" parameterType="com.lec.spring.member.domain.Friend">
        DELETE FROM friend
        WHERE sender_id = #{senderId}
          AND receiver_id = #{receiverId}
    </delete>

    <!-- 수락된 친구 관계 가져오기 -->
    <select id="findAcceptedFriends" parameterType="com.lec.spring.member.domain.Friend" resultType="com.lec.spring.member.domain.Friend">
        SELECT * FROM friend
        WHERE (receiver_id = #{member.id} OR sender_id = #{member.id})
          AND is_accept = true
    </select>


</mapper>